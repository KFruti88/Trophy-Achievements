name: Sync PSN Feeds
on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

# Prevents multiple runs from canceling each other
concurrency:
  group: psn-sync
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Fetch and Combine Feeds
        run: |
          FEEDS=("https://psntrophyleaders.com/user/view/OneLIVIDMAN/rss" "https://psntrophyleaders.com/user/view/joe-punk_/rss" "https://psntrophyleaders.com/user/view/Werewolf_5386/rss" "https://psntrophyleaders.com/user/view/DarkTerrdog/rss")
          echo '<?xml version="1.0" encoding="UTF-8" ?><rss version="2.0"><channel><title>Combined PSN Feeds</title>' > feed.xml
          for url in "${FEEDS[@]}"; do
            curl -s -L "$url" | sed -n '/<item>/,/<\/item>/p' >> feed.xml
          done
          echo '</channel></rss>' >> feed.xml

      - name: Generate HTML Widget
        run: |
          python3 -c "
          import xml.etree.ElementTree as ET
          try:
              tree = ET.parse('feed.xml')
              root = tree.getroot()
              items = root.findall('.//item')[:12]
              with open('feed_widget.html', 'w') as f:
                  f.write('<div style=\"width: 100%; font-family: sans-serif;\">')
                  f.write('<ul style=\"list-style: none; padding: 0; margin: 0;\">')
                  for item in items:
                      title = item.find('title').text if item.find('title') is not None else 'Trophy Earned'
                      link = item.find('link').text if item.find('link') is not None else '#'
                      f.write(f'<li style=\"margin-bottom: 8px; padding: 10px; border-bottom: 1px solid #444;\">')
                      f.write(f'<a href=\"{link}\" target=\"_blank\" style=\"color: #0070d1; text-decoration: none; font-weight: bold;\">{title}</a>')
                      f.write('</li>')
                  f.write('</ul></div>')
          except Exception as e:
              with open('feed_widget.html', 'w') as f:
                  f.write('<p>Trophy data temporarily unavailable.</p>')
          "

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add feed.xml feed_widget.html
          git commit -m "Update PSN Feeds [skip ci]" || exit 0
          git push
